<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Judgement – Minimalist Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#0a1a0a; --card:#fff; --accent:#ffcc00; --table:#2c5f2c;
    --radius:12px; --gap:1rem;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:Helvetica,Arial,sans-serif;background:var(--bg);color:#eee;display:flex;flex-direction:column;align-items:center;padding:1rem;}
  h1{font-size:1.8rem;margin-bottom:.5rem;text-align:center;}
  .screen{display:none;flex-direction:column;align-items:center;width:100%;max-width:800px;}
  .screen.active{display:flex;}
  input,button,select{padding:.6rem 1rem;margin:.3rem;border-radius:var(--radius);font-size:1rem;}
  input,select{background:#222;color:#fff;border:1px solid #444;}
  button{background:var(--accent);color:#000;border:none;cursor:pointer;transition:.2s;}
  button:hover{transform:scale(1.04);}
  .avatar-preview{width:60px;height:60px;border-radius:50%;object-fit:cover;margin:.5rem;}
  #lobbyList,#hostSelect{margin-top:1rem;width:100%;max-width:400px;}
  .player-item{display:flex;align-items:center;gap:.5rem;padding:.4rem;background:#222;border-radius:var(--radius);margin:.3rem 0;}
  #table{
    position:relative;width:90vmin;height:90vmin;max-width:600px;max-height:600px;
    background:var(--table);border-radius:50%;margin:2rem 0;
    box-shadow:0 0 30px rgba(0,0,0,.7);
  }
  .seat{
    position:absolute;width:80px;height:110px;text-align:center;
    transform:translate(-50%,-50%);
  }
  .seat img{width:60px;height:60px;border-radius:50%;object-fit:cover;}
  .seat .name{margin-top:.3rem;font-size:.9rem;}
  .hand{
    position:absolute;bottom:-70px;left:50%;transform:translateX(-50%);
    display:flex;gap:.4rem;flex-wrap:wrap;justify-content:center;
  }
  .card{
    width:45px;height:65px;background:var(--card);color:#000;
    border-radius:6px;display:flex;flex-direction:column;
    align-items:center;justify-content:center;font-weight:bold;
    box-shadow:0 2px 4px rgba(0,0,0,.4);cursor:pointer;
  }
  .card.spades,.card.clubs{color:#000;}
  .card.hearts,.card.diamonds{color:#d00;}
  .trick{display:flex;gap:.5rem;justify-content:center;margin:1rem 0;}
  #msg{color:var(--accent);margin-top:.5rem;}
</style>
</head>
<body>

<!-- ===== REGISTER SCREEN ===== -->
<div id="register" class="screen active">
  <h1>Judgement</h1>
  <input type="text" id="playerName" placeholder="Your name" maxlength="20">
  <select id="avatarSelect">
    <option value="avatar1.jpg">Avatar 1</option>
    <option value="avatar2.jpg">Avatar 2</option>
    <option value="avatar3.jpg">Avatar 3</option>
    <option value="avatar4.jpg">Avatar 4</option>
  </select>
  <img id="avatarPreview" class="avatar-preview" src="avatar1.jpg" alt="preview">
  <button onclick="registerPlayer()">Join Game</button>
</div>

<!-- ===== LOBBY SCREEN ===== -->
<div id="lobby" class="screen">
  <h1>Lobby</h1>
  <div id="lobbyList"></div>
  <select id="hostSelect" style="display:none;"></select>
  <button id="startBtn" style="display:none;" onclick="startGame()">Start Game</button>
  <button onclick="leaveLobby()">Leave</button>
</div>

<!-- ===== GAME SCREEN ===== -->
<div id="game" class="screen">
  <h1 id="roundInfo"></h1>
  <div id="table"></div>
  <div class="hand" id="myHand"></div>
  <div class="trick" id="currentTrick"></div>
  <div id="msg"></div>
  <button onclick="resetGame()">New Game</button>
</div>

<script>
/* ---------- GLOBAL STATE ---------- */
const storage = {
  players: [],          // {id, name, avatar, seat}
  hostId: null,
  round: 1,
  cardsPerRound: 0,
  deck: [],
  hands: {},            // id → [card,…]
  trick: [],            // [{playerId, card}]
  leadSuit: null,
  trump: null,
  bids: {},             // id → bid
  tricksWon: {},        // id → count
  myId: null
};

/* ---------- HELPERS ---------- */
const suits = ['♠','♥','♦','♣'];
const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
function makeDeck(){
  const d = [];
  for(const s of suits)for(const r of ranks) d.push({suit:s,rank:r,value: ranks.indexOf(r)+1});
  return d.sort(()=>Math.random()-.5);
}
function cardToString(c){ return c.rank+c.suit; }
function suitColor(s){ return ['♠','♣'].includes(s)?'spades':'hearts'; }

/* ---------- AVATAR PREVIEW ---------- */
document.getElementById('avatarSelect').addEventListener('change',e=>{
  document.getElementById('avatarPreview').src = e.target.value;
});

/* ---------- REGISTER ---------- */
function registerPlayer(){
  const name = document.getElementById('playerName').value.trim();
  const avatar = document.getElementById('avatarSelect').value;
  if(!name) return alert('Enter a name');
  const id = Date.now().toString();
  const player = {id, name, avatar};
  const existing = JSON.parse(localStorage.getItem('judgementPlayers')||'[]');
  existing.push(player);
  localStorage.setItem('judgementPlayers', JSON.stringify(existing));
  storage.myId = id;
  showScreen('lobby');
  refreshLobby();
}

/* ---------- LOBBY ---------- */
function refreshLobby(){
  const list = document.getElementById('lobbyList');
  const players = JSON.parse(localStorage.getItem('judgementPlayers')||'[]');
  storage.players = players;
  list.innerHTML = '';
  players.forEach(p=>{
    const div = document.createElement('div');
    div.className='player-item';
    div.innerHTML = `<img src="${p.avatar}" width="40" height="40" style="border-radius:50%;"> ${p.name}`;
    list.appendChild(div);
  });
  // show host picker only to the first player (or anyone if you prefer)
  const hostSel = document.getElementById('hostSelect');
  const startBtn = document.getElementById('startBtn');
  if(players.length>=2){
    hostSel.style.display='block';
    startBtn.style.display='block';
    hostSel.innerHTML = '';
    players.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = p.name + ' (host)';
      hostSel.appendChild(opt);
    });
  }else{
    hostSel.style.display='none';
    startBtn.style.display='none';
  }
  setInterval(refreshLobby,3000); // auto-refresh
}
function leaveLobby(){
  let players = JSON.parse(localStorage.getItem('judgementPlayers')||'[]');
  players = players.filter(p=>p.id!==storage.myId);
  localStorage.setItem('judgementPlayers', JSON.stringify(players));
  storage.myId = null;
  showScreen('register');
}

/* ---------- START GAME ---------- */
function startGame(){
  const hostId = document.getElementById('hostSelect').value;
  if(!hostId) return alert('Pick a host');
  storage.hostId = hostId;
  const N = storage.players.length;
  storage.cardsPerRound = Math.floor(52/N);
  storage.round = 1;
  // assign seats (clockwise, host = seat 0)
  storage.players.forEach((p,i)=>p.seat=i);
  // deal first round
  dealRound();
  showScreen('game');
  renderTable();
  renderMyHand();
  if(isMyTurn()) document.getElementById('msg').textContent='Your turn – lead a card';
}

/* ---------- DEAL ---------- */
function dealRound(){
  const N = storage.players.length;
  const cardsThisRound = storage.cardsPerRound - (storage.round-1);
  if(cardsThisRound<=0){
    endGame();
    return;
  }
  storage.deck = makeDeck();
  storage.hands = {};
  storage.trick = [];
  storage.leadSuit = null;
  storage.trump = suits[storage.round%suits.length];
  storage.bids = {};
  storage.tricksWon = {};
  storage.players.forEach(p=>storage.tricksWon[p.id]=0);

  // simple deal
  let idx=0;
  for(let i=0;i<cardsThisRound;i++){
    storage.players.forEach(p=>{
      if(idx<storage.deck.length){
        const card = storage.deck[idx++];
        if(!storage.hands[p.id]) storage.hands[p.id]=[];
        storage.hands[p.id].push(card);
      }
    });
  }
  // sort hands for nice display
  Object.keys(storage.hands).forEach(id=>{
    storage.hands[id].sort((a,b)=>{
      if(a.suit!==b.suit) return suits.indexOf(a.suit)-suits.indexOf(b.suit);
      return a.value-b.value;
    });
  });
}

/* ---------- RENDER TABLE ---------- */
function renderTable(){
  const table = document.getElementById('table');
  table.innerHTML='';
  const N = storage.players.length;
  storage.players.forEach((p,i)=>{
    const angle = (i/N)*2*Math.PI - Math.PI/2;
    const radius = 38; // % of table
    const x = 50 + radius*Math.cos(angle);
    const y = 50 + radius*Math.sin(angle);
    const seat = document.createElement('div');
    seat.className='seat';
    seat.style.left = x+'%';
    seat.style.top = y+'%';
    seat.innerHTML = `<img src="${p.avatar}" alt="${p.name}"><div class="name">${p.name}</div>`;
    table.appendChild(seat);
  });
  document.getElementById('roundInfo').textContent =
    `Round ${storage.round} – ${storage.cardsPerRound-storage.round+1} cards each – Trump: ${storage.trump}`;
  renderCurrentTrick();
}

/* ---------- RENDER MY HAND ---------- */
function renderMyHand(){
  const handDiv = document.getElementById('myHand');
  handDiv.innerHTML='';
  const myCards = storage.hands[storage.myId]||[];
  myCards.forEach(c=>{
    const el = document.createElement('div');
    el.className=`card ${suitColor(c.suit)}`;
    el.textContent = c.rank+c.suit;
    el.dataset.card = JSON.stringify(c);
    el.onclick = ()=>playCard(c,el);
    handDiv.appendChild(el);
  });
}

/* ---------- PLAY CARD ---------- */
function playCard(card,el){
  if(!isMyTurn()) return;
  const myId = storage.myId;
  // remove from hand
  storage.hands[myId] = storage.hands[myId].filter(x=>x!==card);
  el.remove();
  // add to trick
  storage.trick.push({playerId:myId, card});
  if(!storage.leadSuit) storage.leadSuit = card.suit;
  renderCurrentTrick();
  // simple AI for other players (instant)
  setTimeout(()=>nextPlayerPlays(), 600);
}
function nextPlayerPlays(){
  if(storage.trick.length === storage.players.length){
    resolveTrick();
    return;
  }
  const nextId = getNextPlayerId();
  if(nextId===storage.myId) {
    document.getElementById('msg').textContent='Your turn';
    return;
  }
  // AI: play legal card
  const hand = storage.hands[nextId];
  let playable = hand.filter(c=>c.suit===storage.leadSuit);
  if(!playable.length) playable = hand;
  const chosen = playable[0];
  storage.hands[nextId] = storage.hands[nextId].filter(c=>c!==chosen);
  storage.trick.push({playerId:nextId, card:chosen});
  renderCurrentTrick();
  setTimeout(()=>nextPlayerPlays(), 600);
}
function getNextPlayerId(){
  const curIdx = storage.trick.length>0 ?
    storage.players.findIndex(p=>p.id===storage.trick[storage.trick.length-1].playerId) :
    storage.players.findIndex(p=>p.id===storage.hostId);
  return storage.players[(curIdx+1)%storage.players.length].id;
}
function isMyTurn(){
  if(storage.trick.length===0) return storage.hostId===storage.myId;
  const last = storage.trick[storage.trick.length-1].playerId;
  const next = getNextPlayerId();
  return next===storage.myId;
}

/* ---------- TRICK RESOLUTION ---------- */
function resolveTrick(){
  let winner = null;
  let best = null;
  storage.trick.forEach(t=>{
    const val = cardValue(t.card);
    if(!best || val>best.val){
      best={val, player:t.playerId};
    }
  });
  storage.tricksWon[best.player] = (storage.tricksWon[best.player]||0)+1;
  // move lead to winner for next trick
  storage.leadSuit = null;
  storage.trick = [];
  renderCurrentTrick();
  // check if round finished
  if(Object.values(storage.hands).every(h=>h.length===0)){
    setTimeout(()=>nextRound(),1200);
  }else{
    // next trick led by winner
    setTimeout(()=>startNextTrick(best.player),800);
  }
}
function startNextTrick(leaderId){
  storage.trick=[];
  if(leaderId===storage.myId){
    document.getElementById('msg').textContent='You won the trick – lead!';
  }else{
    document.getElementById('msg').textContent='Waiting for next trick...';
    setTimeout(()=>nextPlayerPlays(),800);
  }
}
function cardValue(c){
  let v = c.value;
  if(c.suit===storage.trump) v+=100;
  else if(c.suit!==storage.leadSuit) v=-100;
  return v;
}

/* ---------- RENDER CURRENT TRICK ---------- */
function renderCurrentTrick(){
  const div = document.getElementById('currentTrick');
  div.innerHTML='';
  storage.trick.forEach(t=>{
    const el = document.createElement('div');
    el.className=`card ${suitColor(t.card.suit)}`;
    el.textContent = t.card.rank+t.card.suit;
    div.appendChild(el);
  });
}

/* ---------- NEXT ROUND ---------- */
function nextRound(){
  storage.round++;
  const cardsNext = storage.cardsPerRound - storage.round + 1;
  if(cardsNext<=0){
    endGame();
    return;
  }
  dealRound();
  renderTable();
  renderMyHand();
  document.getElementById('msg').textContent='New round!';
}

/* ---------- END GAME ---------- */
function endGame(){
  let scores = '';
  storage.players.forEach(p=>{
    const won = storage.tricksWon[p.id]||0;
    scores += `${p.name}: ${won} tricks\n`;
  });
  alert('Game Over!\n'+scores);
  resetGame();
}
function resetGame(){
  localStorage.removeItem('judgementPlayers');
  location.reload();
}

/* ---------- SCREEN SWITCH ---------- */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ---------- INIT ---------- */
if(localStorage.getItem('judgementPlayers')){
  const me = JSON.parse(localStorage.getItem('judgementPlayers')).find(p=>p.id===storage.myId);
  if(me) { storage.myId = me.id; showScreen('lobby'); refreshLobby(); }
}
</script>
</body>
</html>